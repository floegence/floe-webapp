name: Release

on:
  push:
    tags:
      - "v*.*.*"
  workflow_dispatch:

concurrency:
  group: release-${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write
  id-token: write

jobs:
  publish:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm
          registry-url: https://registry.npmjs.org

      - name: Ensure npm supports trusted publishing (OIDC)
        run: |
          set -euo pipefail
          npm i -g npm@^11.5.1
          npm --version

      - name: Install
        run: pnpm install --frozen-lockfile

      - name: Validate tag matches package versions
        if: startsWith(github.ref, 'refs/tags/')
        run: |
          set -euo pipefail
          TAG_VERSION="${GITHUB_REF_NAME#v}"
          CORE_VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/core/package.json', 'utf8')).version);")"
          PROTOCOL_VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/protocol/package.json', 'utf8')).version);")"
          INIT_VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/init/package.json', 'utf8')).version);")"
          BOOT_VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/boot/package.json', 'utf8')).version);")"

          if [ "${TAG_VERSION}" != "${CORE_VERSION}" ] || [ "${TAG_VERSION}" != "${PROTOCOL_VERSION}" ] || [ "${TAG_VERSION}" != "${INIT_VERSION}" ] || [ "${TAG_VERSION}" != "${BOOT_VERSION}" ]; then
            echo "Tag version ${TAG_VERSION} must match package versions (core=${CORE_VERSION}, protocol=${PROTOCOL_VERSION}, init=${INIT_VERSION}, boot=${BOOT_VERSION})"
            exit 1
          fi

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Test
        run: pnpm test -- --run

      - name: Build packages
        run: pnpm -r --filter './packages/*' build

      - name: Verify dist
        run: pnpm verify

      - name: Check if @floegence/floe-webapp-core is already published
        id: core_exists
        run: |
          set -euo pipefail
          VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/core/package.json', 'utf8')).version);")"
          if npm view "@floegence/floe-webapp-core@${VERSION}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if @floegence/floe-webapp-protocol is already published
        id: protocol_exists
        run: |
          set -euo pipefail
          VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/protocol/package.json', 'utf8')).version);")"
          if npm view "@floegence/floe-webapp-protocol@${VERSION}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if @floegence/floe-webapp-init is already published
        id: init_exists
        run: |
          set -euo pipefail
          VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/init/package.json', 'utf8')).version);")"
          if npm view "@floegence/floe-webapp-init@${VERSION}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Check if @floegence/floe-webapp-boot is already published
        id: boot_exists
        run: |
          set -euo pipefail
          VERSION="$(node --input-type=module -e "import fs from 'node:fs'; console.log(JSON.parse(fs.readFileSync('packages/boot/package.json', 'utf8')).version);")"
          if npm view "@floegence/floe-webapp-boot@${VERSION}" version >/dev/null 2>&1; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Publish @floegence/floe-webapp-core (npm Trusted Publisher)
        if: steps.core_exists.outputs.exists != 'true'
        working-directory: packages/core
        run: npm publish --access public

      - name: Publish @floegence/floe-webapp-protocol (npm Trusted Publisher)
        if: steps.protocol_exists.outputs.exists != 'true'
        working-directory: packages/protocol
        run: npm publish --access public

      - name: Publish @floegence/floe-webapp-init (npm Trusted Publisher)
        if: steps.init_exists.outputs.exists != 'true'
        working-directory: packages/init
        run: npm publish --access public

      - name: Publish @floegence/floe-webapp-boot (npm Trusted Publisher)
        if: steps.boot_exists.outputs.exists != 'true'
        working-directory: packages/boot
        run: npm publish --access public

      - name: Create GitHub Release
        if: startsWith(github.ref, 'refs/tags/')
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
